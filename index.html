<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ResearchChain - Decentralized Research Data Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        nav {
            display: flex;
            gap: 30px;
        }

        nav a {
            text-decoration: none;
            color: #333;
            font-weight: 500;
            transition: color 0.3s;
            cursor: pointer;
        }

        nav a:hover {
            color: #667eea;
        }

        .wallet-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }

        .wallet-btn:hover {
            transform: translateY(-2px);
        }

        .main-content {
            margin-top: 30px;
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            min-height: 600px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .hero {
            text-align: center;
            padding: 60px 0;
        }

        .hero h1 {
            font-size: 48px;
            color: #667eea;
            margin-bottom: 20px;
        }

        .hero p {
            font-size: 20px;
            color: #666;
            margin-bottom: 40px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
            margin-top: 40px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 15px;
            color: white;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 36px;
            margin-bottom: 10px;
        }

        .stat-card p {
            font-size: 16px;
            opacity: 0.9;
        }

        .section-title {
            font-size: 32px;
            color: #333;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .file-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            transition: transform 0.2s;
        }

        .file-card:hover {
            transform: translateX(5px);
        }

        .file-card h4 {
            color: #333;
            margin-bottom: 10px;
        }

        .file-meta {
            display: flex;
            gap: 20px;
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .file-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .file-actions button {
            padding: 8px 16px;
            font-size: 14px;
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .data-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 25px;
            transition: all 0.3s;
        }

        .data-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.2);
        }

        .data-card h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 5px;
            margin-bottom: 10px;
        }

        .badge-nft {
            background: #ffeaa7;
            color: #d63031;
        }

        .badge-votes {
            background: #dfe6e9;
            color: #2d3436;
        }

        .vote-section {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .account-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .account-info h3 {
            margin-bottom: 15px;
        }

        .wallet-address {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            word-break: break-all;
        }

        .faq-item {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .faq-item h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .upload-zone {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 50px;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .upload-zone:hover {
            background: #e9ecef;
            border-color: #764ba2;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 10px 25px;
            background: #f0f0f0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .history-entry {
            padding: 15px;
            border-left: 3px solid #667eea;
            margin-bottom: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .history-entry .timestamp {
            color: #666;
            font-size: 12px;
        }

        .project-container {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
        }

        .project-container:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
        }

        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            cursor: pointer;
            padding: 15px;
            background: white;
            border-radius: 8px;
        }

        .project-header h3 {
            color: #667eea;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .project-meta {
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: #666;
        }

        .project-files {
            margin-top: 20px;
            display: none;
        }

        .project-files.expanded {
            display: block;
        }

        .file-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 20px;
            transition: all 0.3s;
        }

        .file-item:hover {
            transform: translateX(5px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .file-item.selected {
            border-left-color: #764ba2;
            background: #f0f4ff;
        }

        .file-info {
            flex: 1;
        }

        .file-info h4 {
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .file-detail-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .file-detail-label {
            font-size: 12px;
            color: #666;
            font-weight: 600;
        }

        .file-detail-value {
            font-size: 14px;
            color: #333;
        }

        .file-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            margin-top: 5px;
        }

        .usage-history {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .usage-entry {
            padding: 10px;
            background: white;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 13px;
        }

        .usage-entry:last-child {
            margin-bottom: 0;
        }

        .usage-stats {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e0e0e0;
        }

        .usage-stat {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #666;
            font-size: 14px;
        }

        .expand-icon {
            transition: transform 0.3s;
        }

        .expand-icon.expanded {
            transform: rotate(180deg);
        }

        .bulk-actions {
            display: none;
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 100;
            color: white;
        }

        .bulk-actions.visible {
            display: block;
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .bulk-actions-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-header h3 {
            color: #667eea;
            margin: 0;
        }

        .close-modal {
            font-size: 28px;
            cursor: pointer;
            color: #999;
            border: none;
            background: none;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-modal:hover {
            color: #333;
        }

        .file-detail-modal {
            max-width: 900px;
        }

        .detail-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .detail-section h4 {
            color: #667eea;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .detail-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
        }

        .detail-label {
            font-size: 12px;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .detail-value {
            font-size: 14px;
            color: #333;
            word-break: break-all;
        }

        .blockchain-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .blockchain-info h4 {
            color: white;
            margin-bottom: 15px;
        }

        .reference-log {
            max-height: 300px;
            overflow-y: auto;
        }

        .log-entry {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 3px solid #667eea;
        }

        .log-entry:last-child {
            margin-bottom: 0;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .points-earned {
            background: #ffeaa7;
            color: #d63031;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
        }

        .points-earned h2 {
            font-size: 48px;
            margin: 10px 0;
        }

        .permission-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .permission-badge {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }

        .permission-read {
            background: #74b9ff;
            color: #0984e3;
        }

        .permission-write {
            background: #a29bfe;
            color: #6c5ce7;
        }

        .permission-admin {
            background: #fd79a8;
            color: #e84393;
        }

        .share-link-box {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .share-link-box input {
            flex: 1;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: monospace;
        }

        .project-permissions {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 20px;
            }

            nav {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .hero h1 {
                font-size: 32px;
            }

            .data-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">
                üî¨ ResearchChain
            </div>
            <nav>
                <a onclick="showPage('home')">Home</a>
                <a onclick="showPage('account')">Account</a>
                <a onclick="showPage('files')">My Files</a>
                <a onclick="showPage('platform')">Data Platform</a>
                <a onclick="showPage('about')">About</a>
            </nav>
            <button class="wallet-btn" onclick="connectWallet()">
                <span id="walletText">Connect Wallet</span>
            </button>
        </div>
    </header>

    <div class="container">
        <div class="main-content">
            <!-- HOME PAGE -->
            <div id="home" class="page active">
                <div class="hero">
                    <h1>Decentralized Research Data Platform</h1>
                    <p>Securely store, share, and monetize your research data with blockchain technology</p>
                </div>
                
                <div class="stats">
                    <div class="stat-card">
                        <h3>2,547</h3>
                        <p>Research Datasets</p>
                    </div>
                    <div class="stat-card">
                        <h3>1,234</h3>
                        <p>Active Researchers</p>
                    </div>
                    <div class="stat-card">
                        <h3>5,891</h3>
                        <p>NFT Minted</p>
                    </div>
                    <div class="stat-card">
                        <h3>98%</h3>
                        <p>Data Integrity</p>
                    </div>
                </div>

                <div style="margin-top: 60px;">
                    <h2 class="section-title">Why ResearchChain?</h2>
                    <div class="data-grid">
                        <div class="data-card">
                            <h3>üîí Secure Storage</h3>
                            <p>Your research data is encrypted and stored on decentralized networks, ensuring maximum security and privacy.</p>
                        </div>
                        <div class="data-card">
                            <h3>üé® NFT Ownership</h3>
                            <p>Convert your data into NFTs to prove ownership, maintain provenance, and enable transparent sharing.</p>
                        </div>
                        <div class="data-card">
                            <h3>ü§ù Collaboration</h3>
                            <p>Share data with colleagues, vote on data quality, and collaborate seamlessly across institutions.</p>
                        </div>
                        <div class="data-card">
                            <h3>üí∞ Monetization</h3>
                            <p>Earn tokens when others use your research data, creating a sustainable research ecosystem.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ACCOUNT PAGE -->
            <div id="account" class="page">
                <h2 class="section-title">Account Management</h2>
                
                <div class="account-info">
                    <h3>üë§ User Profile</h3>
                    <div id="accountDetails">
                        <p><strong>Username:</strong> <span id="username">Not connected</span></p>
                        <p style="margin-top: 10px;"><strong>Wallet Address:</strong></p>
                        <div class="wallet-address" id="walletAddress">Connect your wallet to view address</div>
                        <p style="margin-top: 15px;"><strong>Member Since:</strong> <span id="memberSince">-</span></p>
                        <p style="margin-top: 10px;">
                            <strong>Verification Status:</strong> 
                            <span id="verificationStatus" class="badge badge-votes">Not Verified</span>
                        </p>
                    </div>
                </div>

                <div style="background: white; padding: 30px; border-radius: 12px; border: 2px solid #e0e0e0; margin-bottom: 25px;">
                    <h3 style="margin-bottom: 20px; color: #667eea;">Basic Information</h3>
                    <div class="form-group">
                        <label>Update Username</label>
                        <input type="text" id="newUsername" placeholder="Enter new username">
                    </div>
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="userEmail" placeholder="your.email@university.edu">
                    </div>
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="fullName" placeholder="Enter your full name">
                    </div>
                    <button class="btn" onclick="updateProfile()">Update Basic Info</button>
                </div>

                <div style="background: white; padding: 30px; border-radius: 12px; border: 2px solid #e0e0e0; margin-bottom: 25px;">
                    <h3 style="margin-bottom: 20px; color: #667eea;">Identity Verification</h3>
                    <p style="color: #666; margin-bottom: 20px;">Verify your identity to gain access to premium features and increase trust in your research data.</p>
                    
                    <div class="form-group">
                        <label>ID Type</label>
                        <select id="idType">
                            <option>Passport</option>
                            <option>Driver's License</option>
                            <option>National ID</option>
                            <option>University ID</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Upload ID Document</label>
                        <input type="file" id="idDocument" accept="image/*,.pdf" style="padding: 8px;">
                    </div>
                    <div class="form-group">
                        <label>ID Number</label>
                        <input type="text" id="idNumber" placeholder="Enter ID number">
                    </div>
                    <button class="btn" onclick="submitVerification()">Submit for Verification</button>
                </div>

                <div style="background: white; padding: 30px; border-radius: 12px; border: 2px solid #e0e0e0; margin-bottom: 25px;">
                    <h3 style="margin-bottom: 20px; color: #667eea;">Professional Credentials</h3>
                    
                    <div class="form-group">
                        <label>Current Position/Title</label>
                        <input type="text" id="position" placeholder="e.g., Research Scientist, PhD Candidate">
                    </div>
                    <div class="form-group">
                        <label>Institution/Affiliation</label>
                        <input type="text" id="institution" placeholder="e.g., Stanford University">
                    </div>
                    <div class="form-group">
                        <label>Department</label>
                        <input type="text" id="department" placeholder="e.g., Department of Biology">
                    </div>
                    <div class="form-group">
                        <label>Research Fields (comma-separated)</label>
                        <input type="text" id="researchFields" placeholder="e.g., Genomics, Bioinformatics, Cancer Research">
                    </div>
                    <div class="form-group">
                        <label>ORCID iD</label>
                        <input type="text" id="orcidId" placeholder="0000-0000-0000-0000">
                    </div>
                    <div class="form-group">
                        <label>Google Scholar Profile URL</label>
                        <input type="url" id="scholarUrl" placeholder="https://scholar.google.com/citations?user=...">
                    </div>
                    <div class="form-group">
                        <label>Upload CV/Resume</label>
                        <input type="file" id="cvDocument" accept=".pdf,.doc,.docx" style="padding: 8px;">
                    </div>
                    <button class="btn" onclick="updateCredentials()">Save Credentials</button>
                </div>

                <div style="margin-top: 40px;">
                    <h3 style="margin-bottom: 20px;">Account Statistics</h3>
                    <div class="stats">
                        <div class="stat-card">
                            <h3 id="userFiles">0</h3>
                            <p>Files Uploaded</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="userNFTs">0</h3>
                            <p>NFTs Minted</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="userShares">0</h3>
                            <p>Data Shares</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="userTokens">0</h3>
                            <p>Points Earned</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- FILES PAGE -->
            <div id="files" class="page">
                <h2 class="section-title">File Management</h2>
                
                <div class="tab-buttons">
                    <button class="tab-btn active" onclick="showFileTab('upload')">Upload</button>
                    <button class="tab-btn" onclick="showFileTab('myfiles')">My Files</button>
                    <button class="tab-btn" onclick="showFileTab('history')">History</button>
                </div>

                <!-- Upload Tab -->
                <div id="uploadTab" class="file-tab">
                    <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
                        <h3>üìÅ Drop files here or click to browse</h3>
                        <p>Supported formats: PDF, CSV, TXT, JSON, XLSX</p>
                        <input type="file" id="fileInput" style="display:none" onchange="handleFileSelect(event)">
                    </div>

                    <div class="form-group">
                        <label>File Title</label>
                        <input type="text" id="fileTitle" placeholder="Enter descriptive title">
                    </div>
                    
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="fileDescription" rows="4" placeholder="Describe your research data"></textarea>
                    </div>

                    <div class="form-group">
                        <label>Category</label>
                        <select id="fileCategory">
                            <option>Genomics</option>
                            <option>Clinical Trials</option>
                            <option>Environmental</option>
                            <option>Physics</option>
                            <option>Chemistry</option>
                            <option>Social Science</option>
                            <option>Other</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Tags (comma-separated)</label>
                        <input type="text" id="fileTags" placeholder="e.g., genomics, cancer, RNA-seq">
                    </div>

                    <div style="display: flex; gap: 15px; margin-top: 20px;">
                        <button class="btn" onclick="uploadFile()">Upload File</button>
                        <button class="btn btn-secondary" onclick="mintNFT()">Mint as NFT</button>
                    </div>
                </div>

                <!-- My Files Tab -->
                <div id="myfilesTab" class="file-tab" style="display:none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px;">
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn" onclick="createNewProject()">+ New Project</button>
                            <button class="btn btn-secondary" onclick="uploadToProject()">+ Upload File</button>
                        </div>
                        <div style="flex: 1; max-width: 400px; margin: 0 15px;">
                            <input type="text" id="searchFiles" placeholder="üîç Search projects and files..." 
                                   oninput="searchFilesAndProjects()" 
                                   style="width: 100%; padding: 10px 15px; border-radius: 8px; border: 2px solid #e0e0e0;">
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <label style="font-weight: 600;">Sort by:</label>
                            <select id="sortFiles" onchange="renderFilesByProject()" style="padding: 8px 12px; border-radius: 6px; border: 2px solid #e0e0e0;">
                                <option value="date">Date</option>
                                <option value="name">Name</option>
                                <option value="usage">Usage Count</option>
                                <option value="size">Size</option>
                            </select>
                        </div>
                    </div>
                    <div id="projectList"></div>
                </div>

                <!-- History Tab -->
                <div id="historyTab" class="file-tab" style="display:none;">
                    <div id="historyList"></div>
                </div>
            </div>

            <!-- PLATFORM PAGE -->
            <div id="platform" class="page">
                <h2 class="section-title">Data Sharing Platform</h2>
                
                <div style="display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap;">
                    <input type="text" id="searchData" placeholder="üîç Search datasets..." 
                           oninput="searchPlatformData()" 
                           style="flex: 1; min-width: 300px; padding: 12px 15px; border-radius: 8px; border: 2px solid #e0e0e0;">
                    <select id="filterCategory" onchange="filterPlatformData()" style="padding: 12px 15px; border-radius: 8px; border: 2px solid #e0e0e0;">
                        <option value="">All Categories</option>
                        <option value="Genomics">Genomics</option>
                        <option value="Clinical Trials">Clinical Trials</option>
                        <option value="Environmental">Environmental</option>
                        <option value="Physics">Physics</option>
                        <option value="Chemistry">Chemistry</option>
                        <option value="Social Science">Social Science</option>
                    </select>
                    <select id="sortPlatform" onchange="renderDataGrid()" style="padding: 12px 15px; border-radius: 8px; border: 2px solid #e0e0e0;">
                        <option value="votes">Most Voted</option>
                        <option value="recent">Most Recent</option>
                        <option value="usage">Most Used</option>
                    </select>
                </div>

                <div class="data-grid" id="dataGrid"></div>
            </div>

            <!-- ABOUT PAGE -->
            <div id="about" class="page">
                <h2 class="section-title">About ResearchChain</h2>
                
                <div style="margin-bottom: 40px;">
                    <h3 style="margin-bottom: 15px;">Our Mission</h3>
                    <p style="line-height: 1.8; color: #666;">
                        ResearchChain is a decentralized platform that empowers researchers to securely store, 
                        share, and monetize their data using blockchain technology. We believe in open science, 
                        data ownership, and collaborative research that benefits the global scientific community.
                    </p>
                </div>

                <div style="margin-bottom: 40px;">
                    <h3 style="margin-bottom: 15px;">Key Features</h3>
                    <ul style="line-height: 2; color: #666; padding-left: 20px;">
                        <li>üîê End-to-end encrypted data storage</li>
                        <li>üé® NFT minting for data ownership and provenance</li>
                        <li>üó≥Ô∏è Community voting for data quality assurance</li>
                        <li>üíé Token rewards for data sharing and usage</li>
                        <li>üìä Comprehensive analytics and usage tracking</li>
                        <li>ü§ù Seamless collaboration tools</li>
                    </ul>
                </div>

                <h3 style="margin-bottom: 20px;">Frequently Asked Questions</h3>
                
                <div class="faq-item">
                    <h4>What is NFT minting for research data?</h4>
                    <p>NFT minting converts your research data into a unique digital asset on the blockchain, 
                    proving ownership and maintaining an immutable record of provenance.</p>
                </div>

                <div class="faq-item">
                    <h4>How do I earn tokens?</h4>
                    <p>You earn tokens when other researchers access or use your shared data, when you contribute 
                    high-quality datasets, and when you participate in data quality voting.</p>
                </div>

                <div class="faq-item">
                    <h4>Is my data secure?</h4>
                    <p>Yes! All data is encrypted before being stored on decentralized networks. You maintain 
                    complete control over who can access your data through smart contracts.</p>
                </div>

                <div class="faq-item">
                    <h4>What blockchain does ResearchChain use?</h4>
                    <p>We support multiple chains including Ethereum, Polygon, and other EVM-compatible networks 
                    for maximum flexibility and lower transaction costs.</p>
                </div>

                <div class="faq-item">
                    <h4>Can I delete my data?</h4>
                    <p>You can revoke access permissions at any time. However, blockchain records (NFTs, transactions) 
                    are immutable by design for transparency and provenance tracking.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="newProjectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Project</h3>
                <button class="close-modal" onclick="closeModal('newProjectModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Project Name</label>
                <input type="text" id="projectName" placeholder="Enter project name">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="projectDescription" rows="4" placeholder="Describe your research project"></textarea>
            </div>
            <div class="form-group">
                <label>Research Category</label>
                <select id="projectCategory">
                    <option>Genomics</option>
                    <option>Clinical Trials</option>
                    <option>Environmental</option>
                    <option>Physics</option>
                    <option>Chemistry</option>
                    <option>Social Science</option>
                    <option>Other</option>
                </select>
            </div>
            <button class="btn" onclick="saveNewProject()">Create Project</button>
        </div>
    </div>

    <div id="uploadFileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Upload File to Project</h3>
                <button class="close-modal" onclick="closeModal('uploadFileModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Select Project</label>
                <select id="uploadProjectSelect"></select>
            </div>
            <div class="upload-zone" onclick="document.getElementById('modalFileInput').click()" style="padding: 30px; margin-bottom: 20px;">
                <h4>üìÅ Click to select file</h4>
                <p style="margin: 0;">Supported: PDF, CSV, TXT, JSON, XLSX</p>
                <input type="file" id="modalFileInput" style="display:none" onchange="handleModalFileSelect(event)">
            </div>
            <div class="form-group">
                <label>File Title</label>
                <input type="text" id="modalFileTitle" placeholder="Enter file title">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="modalFileDescription" rows="3" placeholder="Describe this file"></textarea>
            </div>
            <button class="btn" onclick="saveFileToProject()">Upload File</button>
        </div>
    </div>

    <div id="usageHistoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Usage History</h3>
                <button class="close-modal" onclick="closeModal('usageHistoryModal')">&times;</button>
            </div>
            <div id="usageHistoryContent"></div>
        </div>
    </div>

    <div id="fileDetailModal" class="modal">
        <div class="modal-content file-detail-modal">
            <div class="modal-header">
                <h3 id="fileDetailTitle">File Details</h3>
                <button class="close-modal" onclick="closeModal('fileDetailModal')">&times;</button>
            </div>
            <div id="fileDetailContent"></div>
        </div>
    </div>

    <div id="sharePermissionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Share & Permissions</h3>
                <button class="close-modal" onclick="closeModal('sharePermissionModal')">&times;</button>
            </div>
            <div id="sharePermissionContent"></div>
        </div>
    </div>

    <div id="projectPermissionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Project Access Control</h3>
                <button class="close-modal" onclick="closeModal('projectPermissionModal')">&times;</button>
            </div>
            <div id="projectPermissionContent"></div>
        </div>
    </div>

    <div id="platformFileDetailModal" class="modal">
        <div class="modal-content file-detail-modal">
            <div class="modal-header">
                <h3 id="platformFileDetailTitle">Dataset Details</h3>
                <button class="close-modal" onclick="closeModal('platformFileDetailModal')">&times;</button>
            </div>
            <div id="platformFileDetailContent"></div>
        </div>
    </div>

    <div class="bulk-actions" id="bulkActions">
        <div><strong><span id="selectedCount">0</span> files selected</strong></div>
        <div class="bulk-actions-buttons">
            <button class="btn" onclick="bulkShare()">Share</button>
            <button class="btn" onclick="bulkMintNFT()">Mint NFT</button>
            <button class="btn btn-secondary" onclick="bulkDownload()">Download</button>
            <button class="btn btn-secondary" onclick="clearSelection()">Clear</button>
        </div>
    </div>

    <script>
/* ======= Full upgraded Files System JS (paste to replace previous script) ======= */

let userData = {
    connected: false,
    username: 'Researcher_' + Math.floor(Math.random() * 10000),
    walletAddress: '',
    files: [], // independent uploaded files (not in projects)
    history: [],
    projects: [],
    profile: {
        email: '',
        fullName: '',
        verified: false,
        position: '',
        institution: '',
        department: '',
        researchFields: [],
        orcidId: '',
        scholarUrl: ''
    }
};

let selectedFiles = new Set();
let modalTempFile = null; // temporarily store file selected in modal
let modalTempProjectId = null;

// -------------------- Sample projects initialization (keeps your sample data) --------------------
function initializeSampleProjects() {
    userData.projects = [
        {
            id: 1,
            name: 'COVID-19 Vaccine Research',
            description: 'Analysis of vaccine efficacy and side effects',
            category: 'Clinical Trials',
            created: new Date('2024-01-15').toISOString(),
            sharedWith: [
                { email: 'dr.johnson@stanford.edu', permission: 'read', addedDate: '2024-02-01' },
                { email: 'dr.smith@mit.edu', permission: 'write', addedDate: '2024-02-15' }
            ],
            files: [
                {
                    id: 101,
                    name: 'Patient_Data_Phase3.csv',
                    size: '2.3 MB',
                    type: 'CSV',
                    uploadDate: new Date('2024-01-20').toISOString(),
                    usageCount: 45,
                    description: 'Phase 3 clinical trial patient data',
                    nft: true,
                    tokenId: 'NFT-' + Math.floor(Math.random() * 100000),
                    contractAddress: '0x' + Array.from({length: 40}, () => Math.floor(Math.random() * 16).toString(16)).join(''),
                    blockchainNetwork: 'Polygon',
                    transactionHash: '0x' + Array.from({length: 64}, () => Math.floor(Math.random() * 16).toString(16)).join(''),
                    owner: 'Dr. Sarah Chen',
                    pointsEarned: 450,
                    sharedWith: [
                        { email: 'dr.garcia@ucla.edu', permission: 'read', addedDate: '2024-03-10' }
                    ],
                    usageHistory: [
                        { user: 'Dr. Johnson', action: 'Downloaded', date: '2024-11-25 14:30', txHash: '0xabc123...', points: 10 },
                        { user: 'Dr. Smith', action: 'Viewed', date: '2024-11-24 09:15', txHash: '0xdef456...', points: 5 },
                        { user: 'Dr. Lee', action: 'Downloaded', date: '2024-11-23 16:45', txHash: '0xghi789...', points: 10 }
                    ],
                    referenceLogs: [
                        { type: 'Citation', source: 'Research Paper: COVID-19 Analysis 2024', date: '2024-11-20', points: 50 },
                        { type: 'Dataset Use', source: 'External Project: Vaccine Efficacy Meta-Analysis', date: '2024-11-18', points: 30 },
                        { type: 'Download', source: 'Academic Institution: Johns Hopkins', date: '2024-11-15', points: 10 }
                    ]
                },
                {
                    id: 102,
                    name: 'Efficacy_Analysis.pdf',
                    size: '1.8 MB',
                    type: 'PDF',
                    uploadDate: new Date('2024-02-10').toISOString(),
                    usageCount: 32,
                    description: 'Statistical analysis of vaccine efficacy',
                    nft: false,
                    owner: 'Dr. Sarah Chen',
                    pointsEarned: 280,
                    sharedWith: [],
                    usageHistory: [
                        { user: 'Dr. Garcia', action: 'Downloaded', date: '2024-11-26 11:20', points: 10 },
                        { user: 'Dr. Chen', action: 'Viewed', date: '2024-11-25 15:30', points: 5 }
                    ],
                    referenceLogs: [
                        { type: 'Citation', source: 'Journal Article', date: '2024-11-22', points: 50 }
                    ]
                },
                {
                    id: 103,
                    name: 'SideEffects_Report.xlsx',
                    size: '980 KB',
                    type: 'XLSX',
                    uploadDate: new Date('2024-03-05').toISOString(),
                    usageCount: 28,
                    description: 'Comprehensive side effects tracking',
                    nft: true,
                    tokenId: 'NFT-' + Math.floor(Math.random() * 100000),
                    contractAddress: '0x' + Array.from({length: 40}, () => Math.floor(Math.random() * 16).toString(16)).join(''),
                    blockchainNetwork: 'Ethereum',
                    transactionHash: '0x' + Array.from({length: 64}, () => Math.floor(Math.random() * 16).toString(16)).join(''),
                    owner: 'Dr. Sarah Chen',
                    pointsEarned: 320,
                    sharedWith: [
                        { email: 'dr.wilson@harvard.edu', permission: 'read', addedDate: '2024-04-01' }
                    ],
                    usageHistory: [
                        { user: 'Dr. Williams', action: 'Downloaded', date: '2024-11-27 08:45', txHash: '0xjkl012...', points: 10 }
                    ],
                    referenceLogs: [
                        { type: 'Dataset Use', source: 'FDA Review Process', date: '2024-11-19', points: 100 }
                    ]
                }
            ]
        },
        {
            id: 2,
            name: 'Climate Impact on Marine Life',
            description: 'Long-term study of ocean temperature effects',
            category: 'Environmental',
            created: new Date('2023-08-10').toISOString(),
            sharedWith: [
                { email: 'ocean.research@noaa.gov', permission: 'read', addedDate: '2023-09-01' }
            ],
            files: [
                {
                    id: 201,
                    name: 'Temperature_Data_2023.csv',
                    size: '5.2 MB',
                    type: 'CSV',
                    uploadDate: new Date('2023-12-15').toISOString(),
                    usageCount: 67,
                    description: 'Ocean temperature measurements',
                    nft: true,
                    tokenId: 'NFT-' + Math.floor(Math.random() * 100000),
                    contractAddress: '0x' + Array.from({length: 40}, () => Math.floor(Math.random() * 16).toString(16)).join(''),
                    blockchainNetwork: 'Polygon',
                    transactionHash: '0x' + Array.from({length: 64}, () => Math.floor(Math.random() * 16).toString(16)).join(''),
                    owner: 'Dr. Sarah Chen',
                    pointsEarned: 720,
                    sharedWith: [
                        { email: 'marine.lab@ucsd.edu', permission: 'write', addedDate: '2024-01-10' }
                    ],
                    usageHistory: [
                        { user: 'Dr. Martinez', action: 'Downloaded', date: '2024-11-26 13:00', txHash: '0xmno345...', points: 10 },
                        { user: 'Dr. Anderson', action: 'Viewed', date: '2024-11-25 10:30', points: 5 },
                        { user: 'Dr. Taylor', action: 'Downloaded', date: '2024-11-24 14:15', txHash: '0xpqr678...', points: 10 }
                    ],
                    referenceLogs: [
                        { type: 'Citation', source: 'Nature Climate Change Article', date: '2024-11-21', points: 150 },
                        { type: 'Dataset Use', source: 'IPCC Report', date: '2024-11-10', points: 200 }
                    ]
                },
                {
                    id: 202,
                    name: 'Species_Migration_Patterns.json',
                    size: '1.1 MB',
                    type: 'JSON',
                    uploadDate: new Date('2024-01-20').toISOString(),
                    usageCount: 41,
                    description: 'Fish migration tracking data',
                    nft: false,
                    owner: 'Dr. Sarah Chen',
                    pointsEarned: 390,
                    sharedWith: [],
                    usageHistory: [
                        { user: 'Dr. Brown', action: 'Downloaded', date: '2024-11-27 09:30', points: 10 }
                    ],
                    referenceLogs: [
                        { type: 'Citation', source: 'Marine Biology Journal', date: '2024-11-16', points: 50 }
                    ]
                }
            ]
        },
        {
            id: 3,
            name: 'Cancer Genomics Study',
            description: 'RNA sequencing analysis of tumor samples',
            category: 'Genomics',
            created: new Date('2024-03-01').toISOString(),
            sharedWith: [],
            files: [
                {
                    id: 301,
                    name: 'RNAseq_Results.txt',
                    size: '8.7 MB',
                    type: 'TXT',
                    uploadDate: new Date('2024-05-15').toISOString(),
                    usageCount: 89,
                    description: 'RNA sequencing raw data',
                    nft: true,
                    tokenId: 'NFT-' + Math.floor(Math.random() * 100000),
                    contractAddress: '0x' + Array.from({length: 40}, () => Math.floor(Math.random() * 16).toString(16)).join(''),
                    blockchainNetwork: 'Ethereum',
                    transactionHash: '0x' + Array.from({length: 64}, () => Math.floor(Math.random() * 16).toString(16)).join(''),
                    owner: 'Dr. Sarah Chen',
                    pointsEarned: 950,
                    sharedWith: [
                        { email: 'genomics@stanford.edu', permission: 'read', addedDate: '2024-06-01' },
                        { email: 'cancer.research@mskcc.org', permission: 'read', addedDate: '2024-07-01' }
                    ],
                    usageHistory: [
                        { user: 'Dr. Kim', action: 'Downloaded', date: '2024-11-27 10:00', txHash: '0xstu901...', points: 10 },
                        { user: 'Dr. Patel', action: 'Viewed', date: '2024-11-26 16:20', points: 5 },
                        { user: 'Dr. Wilson', action: 'Downloaded', date: '2024-11-26 12:45', txHash: '0xvwx234...', points: 10 },
                        { user: 'Dr. Moore', action: 'Viewed', date: '2024-11-25 14:30', points: 5 }
                    ],
                    referenceLogs: [
                        { type: 'Citation', source: 'Cell Journal Publication', date: '2024-11-23', points: 200 },
                        { type: 'Dataset Use', source: 'NIH Research Project', date: '2024-11-12', points: 150 },
                        { type: 'Citation', source: 'Conference Presentation', date: '2024-11-05', points: 75 }
                    ]
                }
            ]
        }
    ];
}
initializeSampleProjects();

// -------------------- Utility helpers --------------------
function $(id) { return document.getElementById(id); }
function closeModal(id) {
    const m = $(id);
    if (m) m.classList.remove('active');
}
function openModal(id) {
    const m = $(id);
    if (m) m.classList.add('active');
}
function formatDate(iso) {
    if (!iso) return '-';
    return new Date(iso).toLocaleString();
}

         function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');

            if (pageId === 'platform') {
                renderDataGrid();
            }
        }

// -------------------- Account & Wallet --------------------
function connectWallet() {
    if (!userData.connected) {
        userData.connected = true;
        userData.walletAddress = '0x' + Array.from({length: 40}, () => 
            Math.floor(Math.random() * 16).toString(16)).join('');
        
        $('walletText').textContent = userData.walletAddress.substring(0, 6) + '...' + userData.walletAddress.substring(38);
        $('username').textContent = userData.username;
        $('walletAddress').textContent = userData.walletAddress;
        $('memberSince').textContent = new Date().toLocaleDateString();
        
        alert('Wallet connected successfully!');
        updateAccountStats();
    }
}

function updateProfile() {
    const email = $('userEmail').value;
    const fullName = $('fullName').value;
    if (email) userData.profile.email = email;
    if (fullName) userData.profile.fullName = fullName;
    if ($('newUsername').value) {
        userData.username = $('newUsername').value;
        $('username').textContent = userData.username;
    }
    alert('Profile updated successfully!');
}

function updateCredentials() {
    userData.profile.position = $('position').value;
    userData.profile.institution = $('institution').value;
    userData.profile.department = $('department').value;
    userData.profile.orcidId = $('orcidId').value;
    userData.profile.scholarUrl = $('scholarUrl').value;
    const fields = $('researchFields').value;
    if (fields) userData.profile.researchFields = fields.split(',').map(s => s.trim());
    alert('Professional credentials updated successfully!');
}

function submitVerification() {
    const idNumber = $('idNumber').value;
    const idDocument = $('idDocument').files[0];
    if (!idNumber || !idDocument) {
        alert('Please provide ID number and upload a document!');
        return;
    }
    setTimeout(() => {
        userData.profile.verified = true;
        $('verificationStatus').textContent = '‚úì Verified';
        $('verificationStatus').className = 'badge badge-nft';
        alert('Verification submitted! Your identity will be verified within 24-48 hours.');
    }, 500);
}

// -------------------- Tabs (home/account/files/platform/about) --------------------
function showPage(pageId) {
    document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
    const el = $(pageId);
    if (el) el.classList.add('active');
    if (pageId === 'platform') renderDataGrid();
}

// -------------------- Files Tab UI control --------------------
function showFileTab(tabName) {
    document.querySelectorAll('.file-tab').forEach(tab => tab.style.display = 'none');
    const tabEl = $(tabName + 'Tab');
    if (tabEl) tabEl.style.display = 'block';

    // set active on corresponding tab button
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    // try to find matching text
    const map = { upload: 'Upload', myfiles: 'My Files', history: 'History' };
    const label = map[tabName] || '';
    const btn = Array.from(document.querySelectorAll('.tab-btn')).find(b => b.textContent.trim().startsWith(label));
    if (btn) btn.classList.add('active');

    if (tabName === 'myfiles') renderFilesByProject();
    if (tabName === 'history') renderHistory();
}

// -------------------- Project & File Rendering --------------------
function renderFilesByProject() {
    const container = $('projectList');
    const search = $('searchFiles').value ? $('searchFiles').value.toLowerCase() : '';
    const sortBy = $('sortFiles').value;

    let projects = userData.projects.slice();

    // filter by search (project name or file name)
    if (search) {
        projects = projects.map(p => {
            const matchedFiles = p.files.filter(f => (
                f.name.toLowerCase().includes(search) ||
                (f.description && f.description.toLowerCase().includes(search))
            ));
            return {
                ...p,
                files: matchedFiles
            };
        }).filter(p => p.name.toLowerCase().includes(search) || p.files.length > 0);
    }

    // sorting projects (by created date or name)
    projects.sort((a,b) => {
        if (sortBy === 'date') return new Date(b.created) - new Date(a.created);
        if (sortBy === 'name') return a.name.localeCompare(b.name);
        if (sortBy === 'usage') {
            const usageA = a.files.reduce((s,f)=>s+ (f.usageCount||0),0);
            const usageB = b.files.reduce((s,f)=>s+ (f.usageCount||0),0);
            return usageB - usageA;
        }
        if (sortBy === 'size') return 0; // size unknown for projects
        return 0;
    });

    if (!projects || projects.length === 0) {
        container.innerHTML = '<p style="text-align:center; color: #666;">No projects found.</p>';
        return;
    }

    container.innerHTML = projects.map(p => `
        <div class="project-container" data-project-id="${p.id}">
            <div class="project-header" onclick="toggleProject(${p.id})">
                <h3>${escapeHtml(p.name)}</h3>
                <div class="project-meta">
                    <span>${escapeHtml(p.category)}</span>
                    <span>${new Date(p.created).toLocaleDateString()}</span>
                    <span>${p.files.length} files</span>
                </div>
            </div>
            <div id="projectFiles-${p.id}" class="project-files">
                ${p.files.length ? p.files.map(f => `
                    <div class="file-item" data-file-id="${f.id}">
                        <div class="file-info">
                            <h4>${escapeHtml(f.name)} ${f.nft ? '<span style="font-size:12px; color:#d73;">üé® NFT</span>' : ''}</h4>
                            <div class="file-details">
                                <div class="file-detail-item">
                                    <div class="file-detail-label">Type</div>
                                    <div class="file-detail-value">${escapeHtml(f.type||'-')}</div>
                                </div>
                                <div class="file-detail-item">
                                    <div class="file-detail-label">Size</div>
                                    <div class="file-detail-value">${escapeHtml(f.size||'-')}</div>
                                </div>
                                <div class="file-detail-item">
                                    <div class="file-detail-label">Uploaded</div>
                                    <div class="file-detail-value">${formatDate(f.uploadDate)}</div>
                                </div>
                            </div>
                        </div>
                        <div style="display:flex; flex-direction:column; gap:8px; align-items:flex-end;">
                            <div style="display:flex; gap:8px;">
                                <button class="btn" onclick="viewFile(${f.id})">View</button>
                                <button class="btn btn-secondary" onclick="shareFile(${f.id})">Share</button>
                                ${!f.nft ? '<button class="btn" onclick="convertToNFT('+f.id+')">Mint NFT</button>' : ''}
                            </div>
                            <input class="file-checkbox" type="checkbox" onclick="toggleFileSelection(event, ${f.id}, ${p.id})">
                        </div>
                    </div>
                `).join('') : '<p style="padding:12px; color:#666;">No files in this project.</p>'}
            </div>
        </div>
    `).join('');

    // refresh bulk UI
    updateBulkUI();
    populateUploadProjectSelect();
}

function toggleProject(id) {
    const sec = $(`projectFiles-${id}`);
    if (!sec) return;
    sec.classList.toggle('expanded');
    // rotate icon if you add one later
}

function escapeHtml(str) {
    if (!str) return '';
    return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

// -------------------- Search & Sort --------------------
function searchFilesAndProjects() {
    renderFilesByProject();
}

// -------------------- New Project & Upload --------------------
function createNewProject() {
    $('projectName').value = '';
    $('projectDescription').value = '';
    $('projectCategory').value = 'Other';
    openModal('newProjectModal');
}

function saveNewProject() {
    const name = $('projectName').value.trim();
    const description = $('projectDescription').value.trim();
    const category = $('projectCategory').value;
    if (!name) { alert('Please enter a project name'); return; }

    const id = userData.projects.length ? Math.max(...userData.projects.map(p=>p.id))+1 : 1;
    userData.projects.unshift({
        id,
        name,
        description,
        category,
        created: new Date().toISOString(),
        sharedWith: [],
        files: []
    });

    closeModal('newProjectModal');
    renderFilesByProject();
    userData.history.push({ action: 'Project Created', file: name, timestamp: new Date().toLocaleString() });
    updateAccountStats();
}

// populate project select in upload modal
function populateUploadProjectSelect() {
    const sel = $('uploadProjectSelect');
    if (!sel) return;
    sel.innerHTML = userData.projects.map(p => `<option value="${p.id}">${escapeHtml(p.name)}</option>`).join('');
}

// open upload-to-project modal
function uploadToProject() {
    populateUploadProjectSelect();
    $('modalFileTitle').value = '';
    $('modalFileDescription').value = '';
    modalTempFile = null;
    openModal('uploadFileModal');
}

function handleModalFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;
    modalTempFile = file;
    $('modalFileTitle').value = file.name;
}

// save file into selected project
function saveFileToProject() {
    if (!userData.connected) { alert('Please connect your wallet first!'); return; }
    const projectId = parseInt($('uploadProjectSelect').value, 10);
    const project = userData.projects.find(p => p.id === projectId);
    if (!project) { alert('Select a valid project'); return; }
    const title = $('modalFileTitle').value.trim();
    if (!title) { alert('Please enter a file title'); return; }
    const description = $('modalFileDescription').value.trim();
    // create file object
    const newId = Math.floor(Math.random() * 100000) + 1000;
    const fileObj = {
        id: newId,
        name: title,
        size: modalTempFile ? `${Math.round(modalTempFile.size/1024)} KB` : 'Unknown',
        type: modalTempFile ? modalTempFile.name.split('.').pop().toUpperCase() : 'Unknown',
        uploadDate: new Date().toISOString(),
        usageCount: 0,
        description,
        nft: false,
        owner: userData.username,
        pointsEarned: 0,
        sharedWith: [],
        usageHistory: [],
        referenceLogs: []
    };
    project.files.unshift(fileObj);
    userData.history.push({ action: 'File Uploaded to Project', file: title, timestamp: new Date().toLocaleString() });
    closeModal('uploadFileModal');
    renderFilesByProject();
    updateAccountStats();
}

// -------------------- View File Detail --------------------
function viewFile(id) {
    // find file across projects
    let found = null;
    let parentProject = null;
    for (const p of userData.projects) {
        const f = p.files.find(x => x.id === id);
        if (f) { found = f; parentProject = p; break; }
    }
    // also check userData.files (top-level)
    if (!found) {
        const f = userData.files.find(x => x.id === id);
        if (f) found = f;
    }
    if (!found) { alert('File not found'); return; }

    // build detail HTML
    const content = [];
    content.push(`<div class="detail-section">
        <h4>Basic Info</h4>
        <div class="detail-grid">
            <div class="detail-item"><div class="detail-label">File Name</div><div class="detail-value">${escapeHtml(found.name)}</div></div>
            <div class="detail-item"><div class="detail-label">Size</div><div class="detail-value">${escapeHtml(found.size||'-')}</div></div>
            <div class="detail-item"><div class="detail-label">Type</div><div class="detail-value">${escapeHtml(found.type||'-')}</div></div>
            <div class="detail-item"><div class="detail-label">Upload Date</div><div class="detail-value">${formatDate(found.uploadDate)}</div></div>
            <div class="detail-item"><div class="detail-label">Owner</div><div class="detail-value">${escapeHtml(found.owner || '-')}</div></div>
            <div class="detail-item"><div class="detail-label">Usage Count</div><div class="detail-value">${found.usageCount || 0}</div></div>
        </div>
    </div>`);

    content.push(`<div class="detail-section"><h4>Description</h4><p>${escapeHtml(found.description || 'No description')}</p></div>`);

    // NFT / Blockchain info
    if (found.nft) {
        content.push(`<div class="detail-section">
            <h4>Blockchain / NFT</h4>
            <div class="detail-grid">
                <div class="detail-item"><div class="detail-label">Token ID</div><div class="detail-value">${escapeHtml(found.tokenId || '-')}</div></div>
                <div class="detail-item"><div class="detail-label">Contract</div><div class="detail-value">${escapeHtml(found.contractAddress || '-')}</div></div>
                <div class="detail-item"><div class="detail-label">Network</div><div class="detail-value">${escapeHtml(found.blockchainNetwork || '-')}</div></div>
                <div class="detail-item"><div class="detail-label">Transaction</div><div class="detail-value">${escapeHtml(found.transactionHash || '-')}</div></div>
            </div>
        </div>`);
    }

    // usage history
    content.push(`<div class="detail-section"><h4>Usage History</h4>`);
    if (found.usageHistory && found.usageHistory.length) {
        content.push(`<div class="reference-log">${found.usageHistory.map(u=>`
            <div class="log-entry">
                <div class="log-header"><strong>${escapeHtml(u.user || 'Unknown')}</strong><span>${escapeHtml(u.date || '')}</span></div>
                <div>${escapeHtml(u.action || '')} (${u.points ? u.points + ' pts' : ''})</div>
            </div>
        `).join('')}</div>`);
    } else {
        content.push('<p style="color:#666;">No usage history yet.</p>');
    }
    content.push(`</div>`);

    // reference logs
    content.push(`<div class="detail-section"><h4>Reference Logs</h4>`);
    if (found.referenceLogs && found.referenceLogs.length) {
        content.push(`<div class="reference-log">${found.referenceLogs.map(r=>`
            <div class="log-entry">
                <div class="log-header"><strong>${escapeHtml(r.type)}</strong><span>${escapeHtml(r.date || '')}</span></div>
                <div>${escapeHtml(r.source || '')} ${r.points ? ' ('+r.points+' pts)' : ''}</div>
            </div>
        `).join('')}</div>`);
    } else {
        content.push('<p style="color:#666;">No reference logs yet.</p>');
    }
    content.push(`</div>`);

    // actions
    content.push(`<div style="display:flex; gap:10px; margin-top:12px;">
        <button class="btn" onclick="downloadFile(${found.id})">Download</button>
        <button class="btn" onclick="openUsageHistoryModal(${found.id})">Usage History</button>
        <button class="btn btn-secondary" onclick="openProjectPermissionModal(${parentProject ? parentProject.id : ''})">Project Permissions</button>
        <button class="btn btn-secondary" onclick="closeModal('fileDetailModal')">Close</button>
    </div>`);

    $('fileDetailTitle').textContent = `File Details - ${found.name}`;
    $('fileDetailContent').innerHTML = content.join('');
    openModal('fileDetailModal');
}

// -------------------- Download / Usage History --------------------
function downloadFile(id) {
    alert('Ê®°Êãü‰∏ãËΩΩ File #' + id + 'ÔºàÂú®ÁúüÂÆûÁéØÂ¢É‰∏ãÂ∫îËß¶ÂèëÂêéÁ´Ø‰∏ãËΩΩÔºâ');
}

function openUsageHistoryModal(fileId) {
    // reuse usageHistoryModal and fill content
    let found = null;
    for (const p of userData.projects) {
        const f = p.files.find(x => x.id === fileId);
        if (f) { found = f; break; }
    }
    if (!found) {
        found = userData.files.find(x => x.id === fileId);
    }
    if (!found) return;
    const html = (found.usageHistory && found.usageHistory.length) ? found.usageHistory.map(u=>`
        <div class="usage-entry">
            <strong>${escapeHtml(u.user)}</strong> ‚Äî ${escapeHtml(u.action)} <span style="float:right">${escapeHtml(u.date)}</span>
            <div style="font-size:12px; color:#666;">Tx: ${escapeHtml(u.txHash||'-')} ‚Äî Points: ${u.points||0}</div>
        </div>
    `).join('') : '<p style="color:#666;">No usage history.</p>';

    $('usageHistoryContent').innerHTML = html;
    openModal('usageHistoryModal');
}

// -------------------- Share & Permissions --------------------
function shareFile(fileId) {
    // open sharePermissionModal with simple UI
    let found = null;
    for (const p of userData.projects) {
        const f = p.files.find(x => x.id === fileId);
        if (f) { found = f; break; }
    }
    if (!found) found = userData.files.find(x => x.id === fileId);
    if (!found) return;

    const content = `<div>
        <p style="color:#666;">Share <strong>${escapeHtml(found.name)}</strong> with an email and choose permission:</p>
        <div class="form-group">
            <label>Email</label>
            <input type="email" id="shareEmail" placeholder="name@institution.edu" style="padding:8px; width:100%; border-radius:6px; border:1px solid #ddd;">
        </div>
        <div class="form-group">
            <label>Permission</label>
            <select id="sharePermission" style="padding:8px; width:100%; border-radius:6px; border:1px solid #ddd;">
                <option value="read">Read</option>
                <option value="write">Write</option>
            </select>
        </div>
        <div style="display:flex; gap:10px; margin-top:12px;">
            <button class="btn" onclick="confirmShare(${fileId})">Share</button>
            <button class="btn btn-secondary" onclick="closeModal('sharePermissionModal')">Cancel</button>
        </div>
    </div>`;
    $('sharePermissionContent').innerHTML = content;
    openModal('sharePermissionModal');
}

function confirmShare(fileId) {
    const email = $('shareEmail').value.trim();
    const perm = $('sharePermission').value;
    if (!email) { alert('ËØ∑ËæìÂÖ•ÊúâÊïàÈÇÆÁÆ±'); return; }

    // find file and add sharedWith
    for (const p of userData.projects) {
        const f = p.files.find(x => x.id === fileId);
        if (f) { f.sharedWith = f.sharedWith || []; f.sharedWith.push({ email, permission: perm, addedDate: new Date().toISOString() }); break; }
    }
    const f2 = userData.files.find(x => x.id === fileId);
    if (f2) { f2.sharedWith = f2.sharedWith || []; f2.sharedWith.push({ email, permission: perm, addedDate: new Date().toISOString() }); }

    userData.history.push({ action: 'File Shared', file: 'File #' + fileId + ' ‚Üí ' + email, timestamp: new Date().toLocaleString() });
    alert('Shared successfully');
    closeModal('sharePermissionModal');
    renderFilesByProject();
}

// -------------------- Project Permissions Modal --------------------
function openProjectPermissionModal(projectId) {
    const p = userData.projects.find(x=>x.id === projectId);
    if (!p) { alert('Project not found'); return; }

    const content = `
        <div>
            <h4>${escapeHtml(p.name)}</h4>
            <p style="color:#666;">Manage access for this project</p>
            <div class="form-group">
                <label>Invite (email)</label>
                <input type="email" id="inviteEmail" placeholder="name@inst.edu" style="padding:8px; width:100%; border-radius:6px; border:1px solid #ddd;">
            </div>
            <div class="form-group">
                <label>Permission</label>
                <select id="invitePerm" style="padding:8px; width:100%; border-radius:6px; border:1px solid #ddd;">
                    <option value="read">Read</option>
                    <option value="write">Write</option>
                    <option value="admin">Admin</option>
                </select>
            </div>
            <div style="margin-top:12px;">
                <button class="btn" onclick="confirmInvite(${projectId})">Invite</button>
                <button class="btn btn-secondary" onclick="closeModal('projectPermissionModal')">Close</button>
            </div>
            <div style="margin-top:15px;">
                <h4 style="margin-bottom:8px;">Current Access</h4>
                ${p.sharedWith.length ? p.sharedWith.map(s=>`
                    <div class="permission-item">
                        <div>${escapeHtml(s.email)}</div>
                        <div class="permission-badge ${s.permission==='read'?'permission-read': s.permission==='write'?'permission-write':'permission-admin'}">${escapeHtml(s.permission)}</div>
                    </div>
                `).join('') : '<p style="color:#666;">No collaborators yet.</p>'}
            </div>
        </div>
    `;
    $('projectPermissionContent').innerHTML = content;
    openModal('projectPermissionModal');
}

function confirmInvite(projectId) {
    const email = $('inviteEmail').value.trim();
    const perm = $('invitePerm').value;
    if (!email) { alert('ËØ∑ËæìÂÖ•ÊúâÊïàÈÇÆÁÆ±'); return; }
    const p = userData.projects.find(x=>x.id === projectId);
    if (!p) return;
    p.sharedWith.push({ email, permission: perm, addedDate: new Date().toISOString() });
    userData.history.push({ action: 'Project Invite', file: `${p.name} ‚Üí ${email}`, timestamp: new Date().toLocaleString() });
    alert('Invited successfully');
    closeModal('projectPermissionModal');
    renderFilesByProject();
}

// -------------------- Convert to NFT (simple simulation) --------------------
function convertToNFT(fileId) {
    if (!userData.connected) { alert('Please connect your wallet first!'); return; }
    for (const p of userData.projects) {
        const f = p.files.find(x => x.id === fileId);
        if (f) {
            f.nft = true;
            f.tokenId = 'NFT-' + Math.floor(Math.random()*100000);
            f.contractAddress = '0x' + Array.from({length: 40}, () => Math.floor(Math.random()*16).toString(16)).join('');
            f.blockchainNetwork = 'Polygon';
            f.transactionHash = '0x' + Array.from({length: 64}, () => Math.floor(Math.random()*16).toString(16)).join('');
            userData.history.push({ action: 'NFT Minted', file: f.name, timestamp: new Date().toLocaleString() });
            alert('NFT minted: ' + f.tokenId);
            renderFilesByProject();
            updateAccountStats();
            return;
        }
    }
    alert('File not found');
}

// -------------------- Selection / Bulk Actions --------------------
function toggleFileSelection(evt, fileId, projectId) {
    // prevent event bubbling to parent click
    evt.stopPropagation();
    const key = `${projectId || '0'}-${fileId}`;
    if (selectedFiles.has(key)) selectedFiles.delete(key);
    else selectedFiles.add(key);
    updateBulkUI();
}

function updateBulkUI() {
    const bulk = $('bulkActions');
    const selectedCount = selectedFiles.size;
    $('selectedCount').textContent = selectedCount;
    if (selectedCount > 0) bulk.classList.add('visible'); else bulk.classList.remove('visible');
}

function clearSelection() {
    selectedFiles.clear();
    // uncheck checkboxes
    document.querySelectorAll('.file-checkbox').forEach(cb => cb.checked = false);
    updateBulkUI();
}

function bulkShare() {
    if (!selectedFiles.size) return alert('No files selected');
    // simple flow: ask for email and permission once, then apply to all
    const email = prompt('Share selected files with (email):');
    if (!email) return;
    const perm = prompt('Permission (read/write):', 'read') || 'read';
    selectedFiles.forEach(key => {
        const [projId, fileId] = key.split('-').map(x=>parseInt(x,10));
        const project = userData.projects.find(p=>p.id===projId);
        if (project) {
            const f = project.files.find(f=>f.id===fileId);
            if (f) f.sharedWith = f.sharedWith || [], f.sharedWith.push({ email, permission: perm, addedDate: new Date().toISOString() });
        }
    });
    alert('Shared selected files.');
    clearSelection();
    renderFilesByProject();
}

function bulkMintNFT() {
    if (!userData.connected) { alert('Please connect wallet'); return; }
    selectedFiles.forEach(key => {
        const [projId, fileId] = key.split('-').map(x=>parseInt(x,10));
        const project = userData.projects.find(p=>p.id===projId);
        if (project) {
            const f = project.files.find(f=>f.id===fileId);
            if (f && !f.nft) {
                f.nft = true;
                f.tokenId = 'NFT-' + Math.floor(Math.random()*100000);
            }
        }
    });
    alert('Minted selected files to NFT (simulated).');
    clearSelection();
    renderFilesByProject();
}

function bulkDownload() {
    if (!selectedFiles.size) return alert('No files selected');
    alert('Ê®°ÊãüÊâπÈáè‰∏ãËΩΩ ' + selectedFiles.size + ' ‰∏™Êñá‰ª∂ÔºàÁúüÂÆûÁéØÂ¢ÉÂ∫îËß¶ÂèëÂêéÁ´ØÔºâ');
    clearSelection();
}

// -------------------- History --------------------
function renderHistory() {
    const list = $('historyList');
    if (!userData.history.length) {
        list.innerHTML = '<p style="text-align:center; color: #666;">No activity yet.</p>';
        return;
    }
    list.innerHTML = userData.history.slice().reverse().map(entry => `
        <div class="history-entry">
            <strong>${escapeHtml(entry.action)}</strong>: ${escapeHtml(entry.file || '')}
            <div class="timestamp">${escapeHtml(entry.timestamp)}</div>
        </div>
    `).join('');
}

// -------------------- Data Grid (platform page) --------------------
const sampleData = [
            { 
                id: 1, 
                title: 'COVID-19 Genomic Sequences', 
                category: 'Genomics', 
                votes: 245, 
                nft: true, 
                author: 'Dr. Smith',
                institution: 'Johns Hopkins University',
                uploadDate: new Date('2024-09-15').toISOString(),
                description: 'Comprehensive genomic sequences of COVID-19 variants collected from multiple regions',
                size: '15.3 MB',
                usageCount: 523,
                tokenId: 'NFT-78934',
                contractAddress: '0x' + Array.from({length: 40}, () => Math.floor(Math.random() * 16).toString(16)).join(''),
                blockchainNetwork: 'Ethereum',
                transactionHash: '0x' + Array.from({length: 64}, () => Math.floor(Math.random() * 16).toString(16)).join(''),
                pointsEarned: 5230,
                downloads: 312,
                citations: 45,
                referenceLogs: [
                    { type: 'Citation', source: 'Nature Medicine - Variant Analysis Study', date: '2024-11-20', points: 200 },
                    { type: 'Dataset Use', source: 'WHO Global Database', date: '2024-11-15', points: 300 },
                    { type: 'Citation', source: 'Lancet - Genomic Surveillance', date: '2024-11-10', points: 200 }
                ]
            },
            { 
                id: 2, 
                title: 'Climate Change Temperature Data', 
                category: 'Environmental', 
                votes: 189, 
                nft: true, 
                author: 'Dr. Johnson',
                institution: 'MIT Climate Lab',
                uploadDate: new Date('2024-08-22').toISOString(),
                description: 'Global temperature measurements from 500+ weather stations spanning 50 years',
                size: '8.7 MB',
                usageCount: 456,
                tokenId: 'NFT-65421',
                contractAddress: '0x' + Array.from({length: 40}, () => Math.floor(Math.random() * 16).toString(16)).join(''),
                blockchainNetwork: 'Polygon',
                transactionHash: '0x' + Array.from({length: 64}, () => Math.floor(Math.random() * 16).toString(16)).join(''),
                pointsEarned: 4560,
                downloads: 287,
                citations: 38,
                referenceLogs: [
                    { type: 'Citation', source: 'IPCC Climate Report 2024', date: '2024-11-18', points: 500 },
                    { type: 'Dataset Use', source: 'European Climate Foundation', date: '2024-11-12', points: 250 }
                ]
            },
            { 
                id: 3, 
                title: 'Cancer Cell RNA-seq Analysis', 
                category: 'Genomics', 
                votes: 312, 
                nft: true, 
                author: 'Dr. Lee',
                institution: 'Stanford Medical School',
                uploadDate: new Date('2024-07-10').toISOString(),
                description: 'RNA sequencing data from 1000+ cancer cell samples across multiple tumor types',
                size: '22.1 MB',
                usageCount: 678,
                tokenId: 'NFT-92156',
                contractAddress: '0x' + Array.from({length: 40}, () => Math.floor(Math.random() * 16).toString(16)).join(''),
                blockchainNetwork: 'Ethereum',
                transactionHash: '0x' + Array.from({length: 64}, () => Math.floor(Math.random() * 16).toString(16)).join(''),
                pointsEarned: 6780,
                downloads: 421,
                citations: 52,
                referenceLogs: [
                    { type: 'Citation', source: 'Cell - Cancer Genomics Study', date: '2024-11-22', points: 300 },
                    { type: 'Citation', source: 'Science - Oncology Research', date: '2024-11-19', points: 300 },
                    { type: 'Dataset Use', source: 'NIH Cancer Database', date: '2024-11-14', points: 400 }
                ]
            },
            { 
                id: 4, 
                title: 'Social Media Behavior Dataset', 
                category: 'Social Science', 
                votes: 156, 
                nft: false, 
                author: 'Dr. Garcia',
                institution: 'UC Berkeley',
                uploadDate: new Date('2024-10-05').toISOString(),
                description: 'Anonymized social media interaction patterns from 50,000 users over 2 years',
                size: '4.5 MB',
                usageCount: 234,
                downloads: 145,
                citations: 18,
                pointsEarned: 2340
            },
            { 
                id: 5, 
                title: 'Quantum Computing Benchmarks', 
                category: 'Physics', 
                votes: 98, 
                nft: true, 
                author: 'Dr. Chen',
                institution: 'Caltech',
                uploadDate: new Date('2024-09-30').toISOString(),
                description: 'Performance benchmarks of quantum algorithms on various quantum processors',
                size: '1.2 MB',
                usageCount: 167,
                tokenId: 'NFT-34789',
                contractAddress: '0x' + Array.from({length: 40}, () => Math.floor(Math.random() * 16).toString(16)).join(''),
                blockchainNetwork: 'Polygon',
                transactionHash: '0x' + Array.from({length: 64}, () => Math.floor(Math.random() * 16).toString(16)).join(''),
                pointsEarned: 1670,
                downloads: 98,
                citations: 12,
                referenceLogs: [
                    { type: 'Citation', source: 'Nature Physics - Quantum Computing', date: '2024-11-21', points: 250 }
                ]
            },
            { 
                id: 6, 
                title: 'Drug Interaction Database', 
                category: 'Clinical Trials', 
                votes: 267, 
                nft: true, 
                author: 'Dr. Williams',
                institution: 'Harvard Medical School',
                uploadDate: new Date('2024-06-18').toISOString(),
                description: 'Comprehensive database of drug-drug interactions from clinical trials and studies',
                size: '12.8 MB',
                usageCount: 589,
                tokenId: 'NFT-45632',
                contractAddress: '0x' + Array.from({length: 40}, () => Math.floor(Math.random() * 16).toString(16)).join(''),
                blockchainNetwork: 'Ethereum',
                transactionHash: '0x' + Array.from({length: 64}, () => Math.floor(Math.random() * 16).toString(16)).join(''),
                pointsEarned: 5890,
                downloads: 367,
                citations: 41,
                referenceLogs: [
                    { type: 'Dataset Use', source: 'FDA Drug Safety Review', date: '2024-11-17', points: 600 },
                    { type: 'Citation', source: 'JAMA - Pharmacology Study', date: '2024-11-13', points: 250 }
                ]
            }
        ];

/* --- Â∞Ü existing renderDataGrid ÊõøÊç¢‰∏∫‰ª•‰∏ãÂÆûÁé∞ --- */

function renderDataGrid() {
            const dataGrid = document.getElementById('dataGrid');
            const sortBy = document.getElementById('sortPlatform').value;
            
            let sortedData = [...sampleData];
            
            switch(sortBy) {
                case 'votes':
                    sortedData.sort((a, b) => b.votes - a.votes);
                    break;
                case 'recent':
                    sortedData.sort((a, b) => new Date(b.uploadDate) - new Date(a.uploadDate));
                    break;
                case 'usage':
                    sortedData.sort((a, b) => b.usageCount - a.usageCount);
                    break;
            }
            
            dataGrid.innerHTML = sortedData.map(data => `
                <div class="data-card">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <h3 style="flex: 1; margin: 0;">${data.title}</h3>
                        ${data.nft ? '<span class="badge badge-nft">NFT</span>' : ''}
                    </div>
                    <p style="color: #666; margin-bottom: 5px; font-size: 14px;">by ${data.author}</p>
                    <p style="color: #999; margin-bottom: 10px; font-size: 13px;">${data.institution || 'Research Institution'}</p>
                    <p style="color: #666; margin-bottom: 15px; font-size: 14px; line-height: 1.5;">${data.description || 'Dataset description not available'}</p>
                    <div style="margin-bottom: 15px;">
                        <span class="badge badge-votes">${data.category}</span>
                        <span class="badge badge-votes">üëç ${data.votes} votes</span>
                        <span class="badge badge-votes">üì• ${data.usageCount} uses</span>
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn" onclick="openPlatformFileDetail(${data.id})" style="flex: 1; min-width: 120px;">View Details</button>
                        <button class="btn" onclick="voteData(${data.id})" style="padding: 10px 20px;">üëç Upvote</button>
                        <button class="btn btn-secondary" onclick="requestAccess(${data.id})" style="flex: 1; min-width: 120px;">Request Access</button>
                    </div>
                </div>
            `).join('');
        }

        function openPlatformFileDetail(dataId) {
            const data = sampleData.find(d => d.id === dataId);
            if (!data) return;

            document.getElementById('platformFileDetailTitle').textContent = data.title;
            
            const content = document.getElementById('platformFileDetailContent');
            content.innerHTML = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h4 style="color: #667eea; margin-bottom: 15px;">üë§ Author Information</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <div style="font-size: 12px; color: #666; font-weight: 600;">Author</div>
                            <div style="margin-top: 5px; color: #333;">${data.author}</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #666; font-weight: 600;">Institution</div>
                            <div style="margin-top: 5px; color: #333;">${data.institution || 'Research Institution'}</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #666; font-weight: 600;">Upload Date</div>
                            <div style="margin-top: 5px; color: #333;">${new Date(data.uploadDate).toLocaleDateString()}</div>
                        </div>
                    </div>
                </div>

                ${data.nft ? `
                <div class="blockchain-info">
                    <h4>‚õìÔ∏è Blockchain Information</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                        <div>
                            <div style="font-size: 12px; opacity: 0.8;">Token ID</div>
                            <div style="font-family: monospace; margin-top: 5px;">${data.tokenId}</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; opacity: 0.8;">Network</div>
                            <div style="margin-top: 5px;">${data.blockchainNetwork}</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; opacity: 0.8;">Contract Address</div>
                            <div style="font-family: monospace; font-size: 11px; margin-top: 5px; word-break: break-all;">${data.contractAddress.substring(0, 10)}...${data.contractAddress.substring(36)}</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; opacity: 0.8;">Transaction Hash</div>
                            <div style="font-family: monospace; font-size: 11px; margin-top: 5px; word-break: break-all;">${data.transactionHash.substring(0, 10)}...${data.transactionHash.substring(60)}</div>
                        </div>
                    </div>
                </div>
                ` : ''}

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div class="stat-card" style="padding: 20px;">
                        <h3 style="margin: 0;">${data.votes}</h3>
                        <p style="margin: 5px 0 0 0; font-size: 14px;">Upvotes</p>
                    </div>
                    <div class="stat-card" style="padding: 20px;">
                        <h3 style="margin: 0;">${data.usageCount}</h3>
                        <p style="margin: 5px 0 0 0; font-size: 14px;">Total Uses</p>
                    </div>
                    <div class="stat-card" style="padding: 20px;">
                        <h3 style="margin: 0;">${data.downloads || Math.floor(data.usageCount * 0.6)}</h3>
                        <p style="margin: 5px 0 0 0; font-size: 14px;">Downloads</p>
                    </div>
                    <div class="stat-card" style="padding: 20px;">
                        <h3 style="margin: 0;">${data.citations || Math.floor(Math.random() * 50)}</h3>
                        <p style="margin: 5px 0 0 0; font-size: 14px;">Citations</p>
                    </div>
                </div>

                <div class="detail-section">
                    <h4>üìÑ Dataset Information</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Category</div>
                            <div class="detail-value">${data.category}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">File Size</div>
                            <div class="detail-value">${data.size || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">NFT Status</div>
                            <div class="detail-value">${data.nft ? '‚úì Minted' : '‚úó Not Minted'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Total Points</div>
                            <div class="detail-value">${data.pointsEarned || 0} ü™ô</div>
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <div class="detail-label">Description</div>
                        <p style="margin-top: 8px; color: #333; line-height: 1.6;">${data.description || 'No description available'}</p>
                    </div>
                </div>

                ${data.referenceLogs && data.referenceLogs.length > 0 ? `
                <div class="detail-section">
                    <h4>üìö Reference & Citation Logs</h4>
                    <p style="color: #666; margin-bottom: 15px; font-size: 14px;">This dataset has been referenced in the following publications and projects:</p>
                    <div class="reference-log">
                        ${data.referenceLogs.map(log => `
                            <div class="log-entry">
                                <div class="log-header">
                                    <div>
                                        <strong>${log.type}</strong>
                                        <div style="color: #666; font-size: 13px; margin-top: 5px;">${log.source}</div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="color: #d63031; font-weight: 600;">+${log.points} points</div>
                                        <div style="color: #999; font-size: 12px; margin-top: 3px;">${log.date}</div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}

                <div class="detail-section">
                    <h4>üìä Usage Statistics</h4>
                    <div style="background: white; padding: 15px; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>Downloads</span>
                            <strong>${data.downloads || Math.floor(data.usageCount * 0.6)}</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>Views</span>
                            <strong>${Math.floor(data.usageCount * 0.4)}</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>Citations</span>
                            <strong>${data.citations || 0}</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>Upvotes</span>
                            <strong>${data.votes}</strong>
                        </div>
                    </div>
                </div>

                <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; margin-top: 20px;">
                    <h4 style="color: #667eea; margin-bottom: 15px;">üîë Access This Dataset</h4>
                    <p style="color: #666; margin-bottom: 15px; font-size: 14px;">Request access to download and use this dataset in your research.</p>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn" onclick="requestAccess(${data.id}); closeModal('platformFileDetailModal');" style="flex: 1; min-width: 150px;">Request Access</button>
                        <button class="btn" onclick="voteData(${data.id})" style="padding: 12px 30px;">üëç Upvote</button>
                    </div>
                </div>
            `;
            
            document.getElementById('platformFileDetailModal').classList.add('active');
        }

        function searchPlatformData() {
            const searchTerm = document.getElementById('searchData').value.toLowerCase();
            const category = document.getElementById('filterCategory').value;
            
            let filtered = sampleData;
            
            if (searchTerm) {
                filtered = filtered.filter(data => 
                    data.title.toLowerCase().includes(searchTerm) || 
                    data.author.toLowerCase().includes(searchTerm) ||
                    data.category.toLowerCase().includes(searchTerm) ||
                    (data.description && data.description.toLowerCase().includes(searchTerm))
                );
            }
            
            if (category) {
                filtered = filtered.filter(data => data.category === category);
            }
            
            const dataGrid = document.getElementById('dataGrid');
            
            if (filtered.length === 0) {
                dataGrid.innerHTML = '<p style="text-align:center; color: #666; padding: 40px;">No datasets found matching your criteria.</p>';
                return;
            }
            
            const sortBy = document.getElementById('sortPlatform').value;
            
            switch(sortBy) {
                case 'votes':
                    filtered.sort((a, b) => b.votes - a.votes);
                    break;
                case 'recent':
                    filtered.sort((a, b) => new Date(b.uploadDate) - new Date(a.uploadDate));
                    break;
                case 'usage':
                    filtered.sort((a, b) => b.usageCount - a.usageCount);
                    break;
            }
            
            dataGrid.innerHTML = filtered.map(data => `
                <div class="data-card">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <h3 style="flex: 1; margin: 0;">${data.title}</h3>
                        ${data.nft ? '<span class="badge badge-nft">NFT</span>' : ''}
                    </div>
                    <p style="color: #666; margin-bottom: 5px; font-size: 14px;">by ${data.author}</p>
                    <p style="color: #999; margin-bottom: 10px; font-size: 13px;">${data.institution || 'Research Institution'}</p>
                    <p style="color: #666; margin-bottom: 15px; font-size: 14px; line-height: 1.5;">${data.description || 'Dataset description not available'}</p>
                    <div style="margin-bottom: 15px;">
                        <span class="badge badge-votes">${data.category}</span>
                        <span class="badge badge-votes">üëç ${data.votes} votes</span>
                        <span class="badge badge-votes">üì• ${data.usageCount} uses</span>
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn" onclick="openPlatformFileDetail(${data.id})" style="flex: 1; min-width: 120px;">View Details</button>
                        <button class="btn" onclick="voteData(${data.id})" style="padding: 10px 20px;">üëç Upvote</button>
                        <button class="btn btn-secondary" onclick="requestAccess(${data.id})" style="flex: 1; min-width: 120px;">Request Access</button>
                    </div>
                </div>
            `).join('');
        }

        function filterPlatformData() {
            searchPlatformData();
        }


/* --- Êñ∞Ë¶èËøΩÂä†: platform ‰∏ÄË¶ß„Ç¢„Ç§„ÉÜ„É†Áî®„ÅÆË©≥Á¥∞Ë°®Á§∫Èñ¢Êï∞ --- */


function voteData(id) {
    alert('ÊÑüË∞¢ÊäïÁ•®ÔºàÊ®°ÊãüÔºâÔºöData #' + id);
}

function requestAccess(id) {
    alert('ËØ∑Ê±ÇËÆøÈóÆ Data #' + id + 'ÔºàÊ®°ÊãüÔºâ');
}

// -------------------- Misc / Account Stats --------------------
function updateAccountStats() {
    // count number of files across projects + top-level files
    const projectFiles = userData.projects.reduce((s,p)=>s + (p.files? p.files.length:0),0);
    const totalFiles = projectFiles + userData.files.length;
    $('userFiles').textContent = totalFiles;
    const totalNFTs = userData.projects.reduce((s,p)=>s + (p.files? p.files.filter(f=>f.nft).length:0),0) + userData.files.filter(f=>f.nft).length;
    $('userNFTs').textContent = totalNFTs;
    $('userShares').textContent = Math.floor(Math.random() * 50);
    $('userTokens').textContent = Math.floor(Math.random() * 500);
}

// -------------------- Utilities to gracefully handle old inline handlers ---------------
function initPageOnLoad() {
    // wire up initial UI state
    renderDataGrid();
    renderFilesByProject();
    populateUploadProjectSelect();
    renderHistory();
    updateAccountStats();

    // attach search input debounce
    const searchInput = $('searchFiles');
    if (searchInput) {
        let t;
        searchInput.addEventListener('input', () => {
            clearTimeout(t);
            t = setTimeout(() => searchFilesAndProjects(), 150);
        });
    }

    // wire up general close modal on background click
    document.querySelectorAll('.modal').forEach(m => {
        m.addEventListener('click', (e) => {
            if (e.target === m) m.classList.remove('active');
        });
    });
}

window.addEventListener('DOMContentLoaded', initPageOnLoad);

// -------------------- Small helpers for compatibility (used by inline HTML) ---------------
function uploadFile() {
    // original Upload file (top-level, not project)
    if (!userData.connected) { alert('Please connect your wallet first!'); return; }
    const title = $('fileTitle').value.trim();
    if (!title) { alert('Please enter a file title!'); return; }
    const description = $('fileDescription').value.trim();
    const category = $('fileCategory').value;
    const tags = $('fileTags').value;

    const newFile = {
        id: Math.floor(Math.random()*100000)+1,
        title,
        description,
        category,
        tags: tags ? tags.split(',').map(t=>t.trim()) : [],
        uploadDate: new Date().toISOString(),
        nft: false,
        shares: 0
    };
    userData.files.push(newFile);
    userData.history.push({ action: 'File Uploaded', file: title, timestamp: new Date().toLocaleString() });
    alert('File uploaded successfully!');
    clearUploadForm();
    updateAccountStats();
    renderFilesByProject();
}

function mintNFT() {
    if (!userData.connected) { alert('Please connect your wallet first!'); return; }
    const title = $('fileTitle').value;
    if (!title) { alert('Please upload a file first!'); return; }
    // upload top-level file and mark nft
    uploadFile();
    const file = userData.files[userData.files.length-1];
    file.nft = true;
    file.tokenId = 'NFT-' + Math.floor(Math.random()*10000);
    userData.history.push({ action: 'NFT Minted', file: title, timestamp: new Date().toLocaleString() });
    alert('NFT minted successfully! Token ID: #' + file.tokenId);
    updateAccountStats();
    renderFilesByProject();
}

function clearUploadForm() {
    $('fileTitle').value = '';
    $('fileDescription').value = '';
    $('fileTags').value = '';
    $('fileInput').value = '';
}

// convenience wrapper for old viewFile call points
// already implemented above

// -------------------- END OF SCRIPT --------------------
</script>
